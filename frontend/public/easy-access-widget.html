<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Access - Prompt Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 8px;
      min-height: 100vh;
      color: white;
      overflow: hidden;
    }

    .widget-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-height: calc(100vh - 16px);
      display: flex;
      flex-direction: column;
    }

    .widget-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 16px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .widget-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .prompts-list {
      overflow-y: auto;
      max-height: calc(100vh - 80px);
      padding: 8px;
    }

    .prompts-list::-webkit-scrollbar {
      width: 6px;
    }

    .prompts-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .prompts-list::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }

    .prompt-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 8px;
      cursor: grab;
      transition: all 0.2s;
      color: #333;
      position: relative;
    }

    .prompt-item:active {
      cursor: grabbing;
    }

    .prompt-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .prompt-item.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }

    .prompt-item.drag-over {
      border-top: 3px solid #667eea;
      margin-top: 12px;
    }

    .prompt-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .prompt-description {
      font-size: 11px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      font-weight: 600;
    }

    .prompt-item:hover .badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .emoji-badge {
      font-size: 12px;
    }

    .loading {
      text-align: center;
      padding: 24px;
      color: #666;
      font-size: 13px;
    }

    .error {
      text-align: center;
      padding: 24px;
      color: #d32f2f;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 24px;
      color: #666;
      font-size: 13px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #323232;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="widget-header" id="header">
      <div class="widget-title">
        <span>‚ö°</span>
        <span>Quick Access</span>
        <span id="count" style="opacity: 0.7; font-size: 12px;"></span>
      </div>
      <button class="refresh-btn" onclick="loadPrompts()">üîÑ Refresh</button>
    </div>
    <div class="prompts-list" id="promptsList">
      <div class="loading">Loading prompts...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    let prompts = [];
    let draggedElement = null;
    let draggedIndex = null;

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load easy access prompts from API
    async function loadPrompts() {
      const promptsList = document.getElementById('promptsList');
      const countEl = document.getElementById('count');

      try {
        promptsList.innerHTML = '<div class="loading">Loading prompts...</div>';

        const response = await fetch(`${API_BASE}/api/prompts/easy-access/list`);
        const data = await response.json();

        prompts = data.prompts || [];
        countEl.textContent = prompts.length > 0 ? `(${prompts.length})` : '';

        if (prompts.length === 0) {
          promptsList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚≠ê</div>
              <div>No quick access prompts yet!</div>
              <div style="margin-top: 8px; font-size: 11px; opacity: 0.6;">
                Star prompts in the main app to add them here
              </div>
            </div>
          `;
          return;
        }

        renderPrompts();

      } catch (error) {
        console.error('Failed to load prompts:', error);
        promptsList.innerHTML = `
          <div class="error">
            Failed to load prompts<br>
            <small>Make sure the backend is running on port 8000</small>
          </div>
        `;
      }
    }

    // Render prompts with drag-and-drop
    function renderPrompts() {
      const promptsList = document.getElementById('promptsList');

      promptsList.innerHTML = prompts.map((prompt, index) => {
        const hasVars = /\{\{[A-Z_]+\}\}/.test(prompt.content);
        const badges = [];

        if (hasVars) badges.push('<span class="emoji-badge">üìù</span>');
        if (prompt.is_ai_enhanced) badges.push('<span class="emoji-badge">‚ú®</span>');

        return `
          <div
            class="prompt-item"
            draggable="true"
            data-index="${index}"
            data-id="${prompt.id}"
            onclick="copyPrompt(${prompt.id})"
            title="${escapeHtml(prompt.description || 'Click to copy. Drag to reorder.')}"
          >
            <div class="prompt-title">
              ${escapeHtml(prompt.title)}
              ${badges.join(' ')}
            </div>
            ${prompt.description ? `<div class="prompt-description">${escapeHtml(prompt.description)}</div>` : ''}
          </div>
        `;
      }).join('');

      // Add drag-and-drop event listeners
      const items = document.querySelectorAll('.prompt-item');
      items.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
        item.addEventListener('dragover', handleDragOver);
        item.addEventListener('drop', handleDrop);
        item.addEventListener('dragleave', handleDragLeave);
      });
    }

    function handleDragStart(e) {
      draggedElement = e.target;
      draggedIndex = parseInt(e.target.dataset.index);
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.innerHTML);
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');

      // Remove all drag-over classes
      const items = document.querySelectorAll('.prompt-item');
      items.forEach(item => item.classList.remove('drag-over'));
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }

      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      e.target.classList.remove('drag-over');

      const dropIndex = parseInt(e.target.closest('.prompt-item').dataset.index);

      if (draggedIndex !== dropIndex) {
        reorderPrompts(draggedIndex, dropIndex);
      }

      return false;
    }

    function handleDragLeave(e) {
      e.target.classList.remove('drag-over');
    }

    // Reorder prompts
    async function reorderPrompts(fromIndex, toIndex) {
      const movedPrompt = prompts[fromIndex];

      // Optimistically update UI
      const newPrompts = [...prompts];
      newPrompts.splice(fromIndex, 1);
      newPrompts.splice(toIndex, 0, movedPrompt);
      prompts = newPrompts;
      renderPrompts();

      try {
        // Send reorder request to backend
        const response = await fetch(`${API_BASE}/api/prompts/easy-access/reorder`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            prompt_id: movedPrompt.id,
            new_position: toIndex,
          }),
        });

        const data = await response.json();

        if (data.success && data.prompts) {
          prompts = data.prompts;
          renderPrompts();
          showToast('‚úì Order updated!', 'success');
        } else {
          // Rollback on error
          await loadPrompts();
          showToast('Failed to reorder', 'error');
        }
      } catch (error) {
        console.error('Reorder error:', error);
        // Rollback on error
        await loadPrompts();
        showToast('Failed to reorder', 'error');
      }
    }

    // Copy prompt to clipboard
    async function copyPrompt(promptId) {
      const prompt = prompts.find(p => p.id === promptId);
      if (!prompt) return;

      // Check for variables
      const hasVars = /\{\{[A-Z_]+\}\}/.test(prompt.content);
      if (hasVars) {
        showToast('‚ö†Ô∏è This prompt has variables - use main app to fill them', 'error');
        return;
      }

      try {
        await navigator.clipboard.writeText(prompt.content);
        showToast(`‚úì Copied "${prompt.title}"`, 'success');
      } catch (error) {
        console.error('Copy failed:', error);
        showToast('Failed to copy to clipboard', 'error');
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Auto-refresh every 30 seconds
    setInterval(loadPrompts, 30000);

    // Initial load
    loadPrompts();
  </script>
</body>
</html>
