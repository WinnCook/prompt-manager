<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quick Access - Prompt Manager</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 8px;
      min-height: 100vh;
      color: white;
      overflow: hidden;
    }

    .widget-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-height: calc(100vh - 16px);
      display: flex;
      flex-direction: column;
    }

    .widget-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 16px;
      color: white;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .widget-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .content-area {
      overflow-y: auto;
      max-height: calc(100vh - 80px);
      padding: 8px;
    }

    .content-area::-webkit-scrollbar {
      width: 6px;
    }

    .content-area::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .content-area::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 3px;
    }

    /* Folder Tree Styles */
    .folder-tree {
      margin-bottom: 8px;
    }

    .folder-item {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      color: #333;
      cursor: pointer;
      transition: background 0.2s;
      border-radius: 4px;
      font-size: 12px;
      user-select: none;
    }

    .folder-item:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .folder-item.selected {
      background: rgba(102, 126, 234, 0.15);
      font-weight: 600;
    }

    .expand-button {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      padding: 0;
      margin-right: 4px;
      font-size: 10px;
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .expand-button:hover {
      color: #667eea;
    }

    .folder-icon {
      margin-right: 6px;
      font-size: 12px;
    }

    .folder-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .folder-children {
      margin-left: 16px;
    }

    /* Section Divider */
    .section-divider {
      margin: 12px 0;
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      color: white;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Prompt Styles */
    .prompts-section {
      margin-top: 8px;
    }

    .prompt-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: #333;
    }

    .prompt-item:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .prompt-title {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .prompt-description {
      font-size: 10px;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .emoji-badge {
      font-size: 11px;
    }

    .prompt-item:hover .prompt-description {
      opacity: 0.9;
    }

    /* States */
    .loading {
      text-align: center;
      padding: 24px;
      color: #666;
      font-size: 13px;
    }

    .error {
      text-align: center;
      padding: 24px;
      color: #d32f2f;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 32px 24px;
      color: #666;
      font-size: 13px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #323232;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.success {
      background: #4caf50;
    }

    .toast.error {
      background: #f44336;
    }

    .toast.warning {
      background: #ff9800;
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="widget-header" id="header">
      <div class="widget-title">
        <span>‚ö°</span>
        <span>Quick Access</span>
      </div>
      <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
    </div>
    <div class="content-area" id="contentArea">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';
    let folders = [];
    let allPrompts = [];
    let starredPrompts = [];
    let expandedFolders = new Set();
    let promptsByFolder = {};

    // Show toast notification
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load both folders and prompts
    async function loadData() {
      const contentArea = document.getElementById('contentArea');

      try {
        contentArea.innerHTML = '<div class="loading">Loading...</div>';

        // Fetch folders, all prompts, and starred prompts in parallel
        const [foldersResponse, allPromptsResponse, starredPromptsResponse] = await Promise.all([
          fetch(`${API_BASE}/api/folders`),
          fetch(`${API_BASE}/api/prompts?limit=10000`),
          fetch(`${API_BASE}/api/prompts/easy-access/list`)
        ]);

        const foldersData = await foldersResponse.json();
        const allPromptsData = await allPromptsResponse.json();
        const starredPromptsData = await starredPromptsResponse.json();

        folders = foldersData.folders || [];
        allPrompts = allPromptsData.prompts || [];
        starredPrompts = starredPromptsData.prompts || [];

        // Organize prompts by folder_id
        promptsByFolder = {};
        allPrompts.forEach(prompt => {
          if (!promptsByFolder[prompt.folder_id]) {
            promptsByFolder[prompt.folder_id] = [];
          }
          promptsByFolder[prompt.folder_id].push(prompt);
        });

        render();

      } catch (error) {
        console.error('Failed to load data:', error);
        contentArea.innerHTML = `
          <div class="error">
            Failed to load data<br>
            <small>Make sure the backend is running on port 8000</small>
          </div>
        `;
      }
    }

    // Render complete widget
    function render() {
      const contentArea = document.getElementById('contentArea');

      let html = '';

      // Render folder tree with prompts
      html += '<div class="folder-tree">';
      html += renderFolderTree(folders);
      html += '</div>';

      // Section divider
      html += '<div class="section-divider"><span>‚≠ê</span><span>Starred Prompts</span></div>';

      // Render starred prompts
      html += '<div class="prompts-section">';
      if (starredPrompts.length === 0) {
        html += `
          <div class="empty-state">
            <div class="empty-state-icon">‚≠ê</div>
            <div>No starred prompts yet!</div>
            <div style="margin-top: 8px; font-size: 11px; opacity: 0.6;">
              Star prompts in the main app<br>to add them here
            </div>
          </div>
        `;
      } else {
        html += renderStarredPrompts();
      }
      html += '</div>';

      contentArea.innerHTML = html;

      // Add event listeners
      attachEventListeners();
    }

    // Render folder tree recursively
    function renderFolderTree(folderList, level = 0) {
      if (!folderList || folderList.length === 0) return '';

      let html = '';

      for (const folder of folderList) {
        const hasChildren = folder.children && folder.children.length > 0;
        const folderPrompts = promptsByFolder[folder.id] || [];
        const hasContent = hasChildren || folderPrompts.length > 0;
        const isExpanded = expandedFolders.has(folder.id);
        const indent = level * 16;

        html += `
          <div class="folder-tree-item">
            <div class="folder-item" style="padding-left: ${indent + 8}px" data-folder-id="${folder.id}">
              <button
                class="expand-button"
                style="visibility: ${hasContent ? 'visible' : 'hidden'}"
                data-folder-id="${folder.id}"
                onclick="toggleFolder(${folder.id}, event)"
              >
                ${isExpanded ? '‚ñº' : '‚ñ∂'}
              </button>
              <span class="folder-icon">üìÅ</span>
              <span class="folder-name">${escapeHtml(folder.name)}</span>
            </div>
            ${isExpanded ? `
              <div class="folder-children">
                ${folderPrompts.length > 0 ? renderFolderPrompts(folderPrompts, level + 1) : ''}
                ${hasChildren ? renderFolderTree(folder.children, level + 1) : ''}
              </div>
            ` : ''}
          </div>
        `;
      }

      return html;
    }

    // Render prompts within a folder
    function renderFolderPrompts(prompts, level) {
      const indent = level * 16;
      return prompts.map(prompt => {
        const hasVars = /\{\{[A-Z_]+\}\}/.test(prompt.content);
        const badges = [];

        if (hasVars) badges.push('<span class="emoji-badge">üìù</span>');
        if (prompt.is_ai_enhanced) badges.push('<span class="emoji-badge">‚ú®</span>');

        return `
          <div
            class="prompt-item"
            style="margin-left: ${indent + 8}px; margin-bottom: 4px;"
            data-prompt-id="${prompt.id}"
            title="${escapeHtml(prompt.description || 'Click to copy')}"
          >
            <div class="prompt-title">
              ${escapeHtml(prompt.title)}
              ${badges.join(' ')}
            </div>
            ${prompt.description ? `<div class="prompt-description">${escapeHtml(prompt.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Render starred prompts list
    function renderStarredPrompts() {
      return starredPrompts.map(prompt => {
        const hasVars = /\{\{[A-Z_]+\}\}/.test(prompt.content);
        const badges = [];

        if (hasVars) badges.push('<span class="emoji-badge">üìù</span>');
        if (prompt.is_ai_enhanced) badges.push('<span class="emoji-badge">‚ú®</span>');

        return `
          <div
            class="prompt-item"
            data-prompt-id="${prompt.id}"
            title="${escapeHtml(prompt.description || 'Click to copy')}"
          >
            <div class="prompt-title">
              ${escapeHtml(prompt.title)}
              ${badges.join(' ')}
            </div>
            ${prompt.description ? `<div class="prompt-description">${escapeHtml(prompt.description)}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // Toggle folder expand/collapse
    function toggleFolder(folderId, event) {
      event.stopPropagation();

      if (expandedFolders.has(folderId)) {
        expandedFolders.delete(folderId);
      } else {
        expandedFolders.add(folderId);
      }

      render();
    }

    // Attach event listeners after render
    function attachEventListeners() {
      // Prompt click handlers
      const promptItems = document.querySelectorAll('.prompt-item');
      promptItems.forEach(item => {
        item.addEventListener('click', function() {
          const promptId = parseInt(this.dataset.promptId);
          copyPrompt(promptId);
        });
      });
    }

    // Copy prompt to clipboard
    async function copyPrompt(promptId) {
      const prompt = allPrompts.find(p => p.id === promptId);
      if (!prompt) return;

      // Check for variables
      const hasVars = /\{\{[A-Z_]+\}\}/.test(prompt.content);
      if (hasVars) {
        showToast('‚ö†Ô∏è This prompt has variables - use main app to fill them', 'warning');
        return;
      }

      try {
        await navigator.clipboard.writeText(prompt.content);
        showToast(`‚úì Copied "${prompt.title}"`, 'success');
      } catch (error) {
        console.error('Copy failed:', error);
        showToast('Failed to copy to clipboard', 'error');
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);

    // Initial load
    loadData();
  </script>
</body>
</html>
